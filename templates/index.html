<!DOCTYPE html>
<html lang="nl">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        :root {
            /* Streamlit Kleuren */
            --bg-color: #0E1117;       
            --sidebar-color: #262730;  
            --card-color: #1E2129;     
            --text-color: #FAFAFA;     
            --secondary-text: #97989C; 
            --accent: #00CC96;         
            --red: #FF4B4B;            
            --blue: #29B5E8;           
        }

        body {
            margin: 0;
            font-family: "Source Sans Pro", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 330px;
            background-color: var(--sidebar-color);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h2 { font-size: 1.5rem; margin-top: 0; margin-bottom: 20px; font-weight: 600; }
        .sidebar h3 { font-size: 0.9rem; color: var(--secondary-text); text-transform: uppercase; margin-top: 20px; margin-bottom: 10px; }
        
        .nav-item {
            display: block; text-decoration: none; color: var(--text-color);
            padding: 10px 15px; margin-bottom: 5px; border-radius: 5px; transition: background 0.2s; font-size: 1rem;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); }
        .nav-item.active { background-color: rgba(100, 100, 100, 0.3); border-left: 4px solid var(--red); padding-left: 11px; }

        .divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0; }
        .info-box { font-size: 0.9rem; color: var(--secondary-text); line-height: 1.6; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }

        input[type="date"] {
            background-color: #1e1e1e; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; width: 90%; font-family: inherit; cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        /* --- MAIN CONTENT --- */
        .main { flex-grow: 1; padding: 2rem 3rem; overflow-y: auto; position: relative; }
        h1 { margin-top: 0; font-size: 2.2rem; font-weight: 700; margin-bottom: 30px; }

        .metrics-row { display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .metric-card { flex: 1; min-width: 200px; }
        .metric-label { font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 5px; }
        .metric-val { font-size: 2.2rem; font-weight: 700; }
        .metric-delta { font-size: 0.9rem; display: flex; align-items: center; gap: 0.4rem; margin-top: 5px; font-weight: 500;}
        .delta-bad { color: var(--red); }
        .delta-good { color: var(--accent); }

        h4 { margin-top: 30px; margin-bottom: 10px; color: var(--secondary-text); font-weight: 400; font-size: 1rem; }
        .chart-container { width: 100%; height: 400px; margin-bottom: 20px; }

        .table-wrap { height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 4px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #1e1e1e; padding: 10px; text-align: left; color: var(--secondary-text); border-bottom: 1px solid #444; }
        td { padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>‚ö° Bediening</h2>
        
        <h3>Navigatie</h3>
        <a href="/" class="nav-item {% if active_page == 'vandaag' %}active{% endif %}">üìä Detailweergave</a>
        <a href="/maand" class="nav-item {% if active_page == 'maand' %}active{% endif %}">üìÖ Historiek (Maand)</a>
        <a href="/jaar" class="nav-item {% if active_page == 'jaar' %}active{% endif %}">üìÜ Overzicht (Jaar)</a>

        <div class="divider"></div>

        {% if active_page == 'vandaag' and data %}
            <h3>Kies Datum</h3>
            <input type="date" id="datumKiezer" value="{{ data.datum }}" onchange="veranderDatum(this)">
            <br><br>
            <div style="font-size: 0.9rem; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="autoRefreshToggle" {% if is_live %}checked{% endif %}> 
                <span style="color: {% if is_live %}#fff{% else %}#666{% endif %};">Live Auto-Refresh (60s)</span>
            </div>
        {% endif %}

        <div class="divider"></div>

        <h3>‚ÑπÔ∏è Info</h3>
        <div class="info-box">
            <div><span class="dot" style="background: var(--accent);"></span>Goedkoop: &lt; {{ config.GRENS_NEGATIEF }} ‚Ç¨</div>
            <div><span class="dot" style="background: var(--red);"></span>Duur: &gt; {{ config.GRENS_DUUR }} ‚Ç¨</div>
        </div>
    </div>

    <div class="main">
        
        {% if active_page == 'vandaag' %}
            <h1>Energy Monitor - {{ data.datum }}</h1>
            
            {% if data and not data.error %}
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-label">Prijs (Laatste meting)</div>
                        {% set prijs = data.huidig.waarde %}
                        <div class="metric-val" style="color: 
                            {% if prijs < data.stats.limits.negatief %}var(--accent)
                            {% elif prijs > data.stats.limits.duur %}var(--red)
                            {% else %}var(--text-color){% endif %};">
                            ‚Ç¨ {{ prijs | round(2) }}
                        </div>
                        {% if data.stats.delta_prijs > 0 %}
                            <div class="metric-delta delta-bad">‚ñ≤ +{{ data.stats.delta_prijs }} vs Gem</div>
                        {% else %}
                            <div class="metric-delta delta-good">‚ñº {{ data.stats.delta_prijs }} vs Gem</div>
                        {% endif %}
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Gemiddeld deze dag</div>
                        <div class="metric-val">‚Ç¨ {{ data.stats.gem }}</div>
                        {% if data.stats.avg_gisteren %}
                            {% if data.stats.delta_avg > 0 %}
                                <div class="metric-delta delta-bad">‚ñ≤ +{{ data.stats.delta_avg }} vs Gisteren</div>
                            {% else %}
                                <div class="metric-delta delta-good">‚ñº {{ data.stats.delta_avg }} vs Gisteren</div>
                            {% endif %}
                        {% else %}
                             <div class="metric-delta" style="color:#666">‚ö™ Geen data dag ervoor</div>
                        {% endif %}
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Laagste / Hoogste</div>
                        <div class="metric-val" style="font-size: 1.8rem;">
                            <span style="color:var(--accent)">{{ data.stats.min }}</span> / 
                            <span style="color:var(--red)">{{ data.stats.max }}</span>
                        </div>
                    </div>
                </div>

                <h4>Onbalansprijs Verloop (Minuutwaarden)</h4>
                <div class="chart-container">
                    <canvas id="liveChart"></canvas>
                </div>
                
                <h4>Settlement Prijzen (Kwartierwaarden)</h4>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="teleChart"></canvas>
                </div>

                <script>
                    function veranderDatum(input) { window.location.href = '/?datum=' + input.value; }

                    // --- 1. SETTINGS & PLUGINS ---
                    const grensDuur = {{ data.stats.limits.duur }};
                    
                    const gridConfig = { color: (ctx) => (ctx.tick && ctx.tick.value === 0 ? '#FFFFFF' : '#333'), lineWidth: (ctx) => (ctx.tick && ctx.tick.value === 0 ? 2 : 1) };
                    const yAxisConfig = { 
                        grid: gridConfig, suggestedMin: -10, suggestedMax: 10, 
                        ticks: { color: '#CCC', font: {weight:'bold'} }, border: {display:false} 
                    };
                    const xAxisConfig = { grid: { display: false }, ticks: { color: '#999', maxTicksLimit: 12 } };

                    // --- 2. LIVE GRAFIEK (Blauw -> Groen & Stippellijn) ---
                    const ctxLive = document.getElementById('liveChart').getContext('2d');
                    
                    // De Gradient (Blauwe Gloed)
                    const grad = ctxLive.createLinearGradient(0,0,0,400);
                    grad.addColorStop(0, 'rgba(41, 181, 232, 0.3)');
                    grad.addColorStop(1, 'rgba(41, 181, 232, 0)');

                    new Chart(ctxLive, {
                        type: 'line',
                        data: {
                            labels: {{ data.full.tijden|tojson }},
                            datasets: [{
                                data: {{ data.full.prijzen|tojson }},
                                borderColor: '#29B5E8', // Standaard Blauw
                                // HIER GEBEURT DE MAGIE: Als waarde < 0, maak lijn groen
                                segment: {
                                    borderColor: ctx => ctx.p0.parsed.y < 0 && ctx.p1.parsed.y < 0 ? '#00CC96' : undefined
                                },
                                backgroundColor: grad, fill: true,
                                borderWidth: 2, pointRadius: 0, tension: 0.3
                            }]
                        },
                        options: { 
                            maintainAspectRatio: false, 
                            scales: { x: xAxisConfig, y: yAxisConfig }, 
                            plugins: {
                                legend: {display:false},
                                // HIER IS DE RODE STIPPELLIJN
                                annotation: {
                                    annotations: {
                                        line1: {
                                            type: 'line',
                                            yMin: grensDuur,
                                            yMax: grensDuur,
                                            borderColor: '#FF4B4B',
                                            borderWidth: 2,
                                            borderDash: [5, 5], // Stippels!
                                            label: {
                                                display: true,
                                                content: 'Dure Grens (' + grensDuur + ')',
                                                position: 'end',
                                                color: '#FF4B4B',
                                                backgroundColor: 'rgba(0,0,0,0.5)'
                                            }
                                        }
                                    }
                                }
                            } 
                        }
                    });

                    // --- 3. TELEGRAM GRAFIEK (Nu ook met Gradient!) ---
                    const ctxTele = document.getElementById('teleChart').getContext('2d');
                    
                    // Gradient voor de Kwartiergrafiek (Groen/Turquoise)
                    const gradTele = ctxTele.createLinearGradient(0,0,0,300);
                    gradTele.addColorStop(0, 'rgba(0, 204, 150, 0.3)');
                    gradTele.addColorStop(1, 'rgba(0, 204, 150, 0)');

                    new Chart(ctxTele, {
                        type: 'line',
                        data: {
                            labels: {{ data.tele.tijden|tojson }},
                            datasets: [{
                                data: {{ data.tele.prijzen|tojson }},
                                borderColor: '#00CC96', 
                                backgroundColor: gradTele, // Gradient toegepast
                                fill: true,                // Invullen!
                                borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#00CC96', tension: 0
                            }]
                        },
                        options: { maintainAspectRatio: false, scales: { x: xAxisConfig, y: yAxisConfig }, plugins: {legend: {display:false}} }
                    });

                    // --- 4. AUTO REFRESH LOGICA ---
                    let refreshTimer;
                    function startRefreshTimer() {
                        const toggle = document.getElementById('autoRefreshToggle');
                        if (toggle && toggle.checked) {
                            console.log("‚è≥ Refresh gestart (60s)...");
                            refreshTimer = setTimeout(() => location.reload(), 60000);
                        }
                    }
                    startRefreshTimer();
                    const toggleBtn = document.getElementById('autoRefreshToggle');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('change', function() {
                            if (this.checked) startRefreshTimer();
                            else { console.log("‚è∏Ô∏è Gepauzeerd"); clearTimeout(refreshTimer); }
                        });
                    }
                </script>
            {% else %}
                <h2>Geen data gevonden voor {{ data.datum }}</h2>
                <p>Kies een andere datum.</p>
                <script>function veranderDatum(input) { window.location.href = '/?datum=' + input.value; }</script>
            {% endif %}
        {% endif %}

        {% if active_page == 'maand' %}
            <h1>Historiek (Maand)</h1>
            {% if history %}
                <div class="chart-container"><canvas id="barChart"></canvas></div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Datum</th><th>Gem</th><th>Min</th><th>Max</th><th>Negatief</th><th>Duur</th></tr></thead>
                        <tbody>
                            {% for i in range(history.datum|length -1, -1, -1) %}
                            <tr>
                                <td>{{ history.datum[i] }}</td>
                                <td>‚Ç¨ {{ history.gemiddelde[i] }}</td>
                                <td style="color:var(--accent)">‚Ç¨ {{ history.laagste[i] }}</td>
                                <td style="color:var(--red)">‚Ç¨ {{ history.hoogste[i] }}</td>
                                <td>{{ history.aantal_negatief[i] }}m</td>
                                <td>{{ history.aantal_duur[i] }}m</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: {
                            labels: {{ history.datum|tojson }},
                            datasets: [
                                { label: 'Negatief', data: {{ history.aantal_negatief|tojson }}, backgroundColor: '#00CC96' },
                                { label: 'Normaal', data: {{ history.normaal|tojson }}, backgroundColor: '#29B5E8' },
                                { label: 'Duur', data: {{ history.aantal_duur|tojson }}, backgroundColor: '#FF2B2B' },
                                { label: 'Gemist', data: {{ history.gemist|tojson }}, backgroundColor: '#444' }
                            ]
                        },
                        options: { maintainAspectRatio: false, scales: { x: {stacked:true, grid:{display:false}}, y: {stacked:true, grid:{color:'#333'}} } }
                    });
                </script>
            {% else %}
                <h2>Geen data.</h2>
            {% endif %}
        {% endif %}

        {% if active_page == 'jaar' %}
            <h1>Jaaroverzicht</h1>
            {% if year %}
                <h4>Uren per Categorie</h4>
                <div class="chart-container" style="height:300px"><canvas id="yearChart"></canvas></div>
                <h4>Prijsontwikkeling</h4>
                <div class="chart-container" style="height:300px"><canvas id="priceYearChart"></canvas></div>
                <script>
                    new Chart(document.getElementById('yearChart'), {
                        type: 'bar',
                        data: {
                            labels: {{ year.maand|tojson }},
                            datasets: [
                                { label: 'Uren Negatief', data: {{ year.uren_negatief|tojson }}, backgroundColor: '#00CC96' },
                                { label: 'Uren Duur', data: {{ year.uren_duur|tojson }}, backgroundColor: '#FF2B2B' }
                            ]
                        },
                        options: { maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y: {grid:{color:'#333'}} } }
                    });
                    new Chart(document.getElementById('priceYearChart'), {
                        type: 'line',
                        data: {
                            labels: {{ year.maand|tojson }},
                            datasets: [
                                { label: 'Gemiddelde', data: {{ year.gem_prijs|tojson }}, borderColor: '#FFA421', borderWidth: 3, tension: 0.2 },
                                { label: 'Laagste', data: {{ year.laagste|tojson }}, borderColor: '#00CC96', borderDash: [5,5] },
                                { label: 'Hoogste', data: {{ year.hoogste|tojson }}, borderColor: '#FF2B2B', borderDash: [5,5] }
                            ]
                        },
                        options: { maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y: {grid:{color:'#333'}} } }
                    });
                </script>
            {% else %}
                <h2>Geen data.</h2>
            {% endif %}
        {% endif %}

    </div> 
</body>
</html>