<!DOCTYPE html>
<html lang="nl">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Energy Monitor</title>

    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}?v=7">
    <meta name="theme-color" content="#0E1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Energy">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=1">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/monthSelect/style.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/monthSelect/index.js"></script>
    <script src="//cdn.rawgit.com/Mikhus/canvas-gauges/gh-pages/download/2.1.7/all/gauge.min.js"></script>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <h2>‚ö° Bediening</h2>
        
        <h3>Navigatie</h3>
        <a href="/" class="nav-item {% if active_page == 'vandaag' %}active{% endif %}">üìä Detailweergave</a>
        <a href="/maand" class="nav-item {% if active_page == 'maand' %}active{% endif %}">üìÖ Historiek (Maand)</a>
        <a href="/jaar" class="nav-item {% if active_page == 'jaar' %}active{% endif %}">üìÜ Overzicht (Jaar)</a>

        <div class="divider"></div>

        {% if active_page == 'vandaag' and data %}
            <h3>Kies Datum</h3>
            <div id="datumKiezer"></div>
            <br>
            <div style="font-size: 0.9rem; display: flex; align-items: center; gap: 10px; padding-left: 10px;">
                <input type="checkbox" id="autoRefreshToggle" {% if is_live %}checked{% endif %}> 
                <span style="color: {% if is_live %}#fff{% else %}#666{% endif %};">Live (60s)</span>
            </div>
        {% endif %}

        {% if active_page == 'maand' and history %}
            <h3>Kies Maand</h3>
            <div id="maandKiezer"></div>
        {% endif %}

        {% if active_page == 'jaar' and year %}
            <h3>Kies Jaar</h3>
            <style>.jaar-select { background: #1e1e1e; color: white; border: 1px solid #444; padding: 10px; width: 100%; border-radius: 5px; font-size: 1rem; cursor: pointer; }</style>
            <select class="jaar-select" onchange="window.location.href='/jaar?jaar='+this.value">
                {% set huidig = year.jaar|int %}
                {% for j in range(2024, huidig + 2) %}
                    <option value="{{ j }}" {% if j == huidig %}selected{% endif %}>{{ j }}</option>
                {% endfor %}
            </select>
        {% endif %}

        <div class="divider"></div>

        <h3>‚ÑπÔ∏è Info</h3>
        <div class="info-box" style="padding-left: 10px;">
            <div><span class="dot" style="background: var(--accent);"></span>Goedkoop: &lt; {{ config.GRENS_NEGATIEF }} ‚Ç¨</div>
            <div><span class="dot" style="background: var(--red);"></span>Duur: &gt; {{ config.GRENS_DUUR }} ‚Ç¨</div>
        </div>
    </div>

    <div class="main">
        
        {% if active_page == 'vandaag' %}
            <h1>Energy Monitor - {{ data.datum }}</h1>
            
            {% if data and not data.error %}
                <div class="metrics-row">
                    {% if is_live %}
                    <div class="metric-card">
                        <div class="metric-label">Prijs (Laatste)</div>
                        {% set prijs = data.huidig.waarde %}
                        <div class="metric-val" style="color: 
                            {% if prijs < data.stats.limits.negatief %}var(--accent)
                            {% elif prijs > data.stats.limits.duur %}var(--red)
                            {% else %}var(--text-color){% endif %};">
                            ‚Ç¨ {{ prijs | round(2) }}
                        </div>
                        {% if data.stats.delta_prijs > 0 %}
                            <div class="metric-delta delta-bad">‚ñ≤ +{{ data.stats.delta_prijs }} vs Gem</div>
                        {% else %}
                            <div class="metric-delta delta-good">‚ñº {{ data.stats.delta_prijs }} vs Gem</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="metric-card">
                        <div class="metric-label">Gemiddeld</div>
                        <div class="metric-val">‚Ç¨ {{ data.stats.gem }}</div>
                        {% if data.stats.avg_gisteren %}
                            {% if data.stats.delta_avg > 0 %}
                                <div class="metric-delta delta-bad">‚ñ≤ +{{ data.stats.delta_avg }} vs Gister</div>
                            {% else %}
                                <div class="metric-delta delta-good">‚ñº {{ data.stats.delta_avg }} vs Gister</div>
                            {% endif %}
                        {% else %}
                             <div class="metric-delta" style="color:#666">‚ö™ Geen data</div>
                        {% endif %}
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Min / Max</div>
                        <div class="metric-val" style="font-size: 1.8rem;">
                            <span style="color:var(--accent)">{{ data.stats.min }}</span> / 
                            <span style="color:var(--red)">{{ data.stats.max }}</span>
                        </div>
                    </div>
                </div>

                <h4>Onbalansprijs (Minuut)</h4>
                <div class="chart-container">
                    <canvas id="liveChart"></canvas>
                </div>
                
                <h4>Settlement (Kwartier)</h4>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="teleChart"></canvas>
                </div>

                <script>
                    function veranderDatum(input) { window.location.href = '/?datum=' + input.value; }
                    const grensDuur = {{ data.stats.limits.duur }};
                    const gridConfig = { color: (ctx) => (ctx.tick && ctx.tick.value === 0 ? '#FFFFFF' : '#333'), lineWidth: (ctx) => (ctx.tick && ctx.tick.value === 0 ? 2 : 1) };
                    const yAxisConfig = { grid: gridConfig, suggestedMin: -10, suggestedMax: 10, ticks: { color: '#CCC', font: {weight:'bold'} }, border: {display:false} };
                    const xAxisConfig = { grid: { display: false }, ticks: { color: '#999', maxTicksLimit: 8 } };

                    const ctxLive = document.getElementById('liveChart').getContext('2d');
                    const grad = ctxLive.createLinearGradient(0,0,0,400);
                    grad.addColorStop(0, 'rgba(41, 181, 232, 0.3)');
                    grad.addColorStop(1, 'rgba(41, 181, 232, 0)');

                    new Chart(ctxLive, {
                        type: 'line',
                        data: {
                            labels: {{ data.full.tijden|tojson }},
                            datasets: [{
                                data: {{ data.full.prijzen|tojson }},
                                borderColor: '#29B5E8', 
                                segment: { borderColor: ctx => ctx.p0.parsed.y < 0 && ctx.p1.parsed.y < 0 ? '#00CC96' : undefined },
                                backgroundColor: grad, fill: true, borderWidth: 2, pointRadius: 0, tension: 0.3
                            }]
                        },
                        options: { 
                            maintainAspectRatio: false, 
                            scales: { x: xAxisConfig, y: yAxisConfig },
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: {display:false},
                                annotation: { annotations: { line1: { type: 'line', yMin: grensDuur, yMax: grensDuur, borderColor: '#FF4B4B', borderWidth: 2, borderDash: [5, 5] } } }
                            } 
                        }
                    });

                    const ctxTele = document.getElementById('teleChart').getContext('2d');
                    const gradTele = ctxTele.createLinearGradient(0,0,0,300);
                    gradTele.addColorStop(0, 'rgba(0, 204, 150, 0.3)');
                    gradTele.addColorStop(1, 'rgba(0, 204, 150, 0)');

                    new Chart(ctxTele, {
                        type: 'line',
                        data: {
                            labels: {{ data.tele.tijden|tojson }},
                            datasets: [{
                                data: {{ data.tele.prijzen|tojson }},
                                borderColor: '#00CC96', backgroundColor: gradTele, fill: true,
                                borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#00CC96', tension: 0
                            }]
                        },
                        options: { maintainAspectRatio: false, scales: { x: xAxisConfig, y: yAxisConfig }, interaction: { mode: 'index', intersect: false }, plugins: {legend: {display:false}} }
                    });

                    let refreshTimer;
                    function startRefreshTimer() {
                        const toggle = document.getElementById('autoRefreshToggle');
                        if (toggle && toggle.checked) refreshTimer = setTimeout(() => location.reload(), 60000);
                    }
                    startRefreshTimer();
                    const toggleBtn = document.getElementById('autoRefreshToggle');
                    if (toggleBtn) toggleBtn.addEventListener('change', function() { if (this.checked) startRefreshTimer(); else clearTimeout(refreshTimer); });
                </script>
            {% else %}
                <h2>Geen data gevonden voor {{ data.datum }}</h2>
                <script>function veranderDatum(input) { window.location.href = '/?datum=' + input.value; }</script>
            {% endif %}
        {% endif %}

        {% if active_page == 'maand' %}
            <h1>Historiek ({{ history.maand }})</h1>
            {% if history and history.datum %}
                <div class="chart-container"><canvas id="barChart"></canvas></div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Datum</th><th>Gem</th><th>Min</th><th>Max</th><th>Neg</th><th>Duur</th></tr></thead>
                        <tbody>
                            {% for i in range(history.datum|length -1, -1, -1) %}
                            <tr>
                                <td>{{ history.datum[i] }}</td>
                                <td>‚Ç¨ {{ history.gemiddelde[i] }}</td>
                                <td style="color:var(--accent)">{{ history.laagste[i] }}</td>
                                <td style="color:var(--red)">{{ history.hoogste[i] }}</td>
                                <td>{{ history.aantal_negatief[i] }}m</td>
                                <td>{{ history.aantal_duur[i] }}m</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: {
                            labels: {{ history.datum|tojson }},
                            datasets: [
                                { label: 'Negatief', data: {{ history.aantal_negatief|tojson }}, backgroundColor: '#00CC96' },
                                { label: 'Normaal', data: {{ history.normaal|tojson }}, backgroundColor: '#29B5E8' },
                                { label: 'Duur', data: {{ history.aantal_duur|tojson }}, backgroundColor: '#FF2B2B' },
                                { label: 'Gemist', data: {{ history.gemist|tojson }}, backgroundColor: '#444' }
                            ]
                        },
                        options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: {stacked:true, grid:{display:false}}, y: {stacked:true, grid:{color:'#333'}} } }
                    });
                </script>
            {% else %}
                <h2>Geen data.</h2>
            {% endif %}
        {% endif %}

        {% if active_page == 'jaar' %}
            <h1>Jaaroverzicht ({{ year.jaar }})</h1>
            {% if year and year.maand %}
                <h4>Uren per Categorie</h4>
                <div class="chart-container" style="height:300px"><canvas id="yearChart"></canvas></div>
                <h4>Prijsontwikkeling</h4>
                <div class="chart-container" style="height:300px"><canvas id="priceYearChart"></canvas></div>
                <script>
                    new Chart(document.getElementById('yearChart'), {
                        type: 'bar',
                        data: {
                            labels: {{ year.maand|tojson }},
                            datasets: [{ label: 'Uren Negatief', data: {{ year.uren_negatief|tojson }}, backgroundColor: '#00CC96' }, { label: 'Uren Duur', data: {{ year.uren_duur|tojson }}, backgroundColor: '#FF2B2B' }]
                        },
                        options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x:{grid:{display:false}}, y: {grid:{color:'#333'}} } }
                    });
                    new Chart(document.getElementById('priceYearChart'), {
                        type: 'line',
                        data: {
                            labels: {{ year.maand|tojson }},
                            datasets: [{ label: 'Gemiddelde', data: {{ year.gem_prijs|tojson }}, borderColor: '#FFA421', borderWidth: 3, tension: 0.2 }, { label: 'Laagste', data: {{ year.laagste|tojson }}, borderColor: '#00CC96', borderDash: [5,5] }, { label: 'Hoogste', data: {{ year.hoogste|tojson }}, borderColor: '#FF2B2B', borderDash: [5,5] }]
                        },
                        options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x:{grid:{display:false}}, y: {grid:{color:'#333'}} } }
                    });
                </script>
            {% else %}
                <h2>Geen data.</h2>
            {% endif %}
        {% endif %}

    </div> 

    <script>
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            if (sidebar.classList.contains('active')) { overlay.style.display = 'block'; } else { overlay.style.display = 'none'; }
        }

        {% if active_page == 'vandaag' and data %}
        flatpickr("#datumKiezer", { inline: true, dateFormat: "Y-m-d", defaultDate: "{{ data.datum }}", theme: "dark", onChange: function(selectedDates, dateStr) { window.location.href = '/?datum=' + dateStr; } });
        {% endif %}

        {% if active_page == 'maand' and history %}
        flatpickr("#maandKiezer", { inline: true, plugins: [ new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "F Y", theme: "dark" }) ], defaultDate: "{{ history.maand }}", onChange: function(selectedDates, dateStr) { window.location.href = '/maand?maand=' + dateStr; } });
        {% endif %}
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("/sw.js", { scope: '/' })
                .then(() => console.log("Service Worker Geregistreerd!"))
                .catch((err) => console.log("Service Worker Fout:", err));
        }
    </script>
</body>
</html>